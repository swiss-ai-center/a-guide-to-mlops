base_tmp_path: tmp/the-guide/generated_checkpoints
base_save_path: docs/the-guide

saves:
  chapter-1-run-a-simple-ml-experiment:
    save_git: false
    actions:
      # Download and set up the codebase
      - run: wget https://github.com/csia-pme/a-guide-to-mlops/archive/refs/heads/code.zip -O code.zip
      - run: unzip -o code.zip
      - run: mv a-guide-to-mlops-code/* .
      - run: rm -r code.zip a-guide-to-mlops-code
      - run: rm code.zip
      # Download and set up the dataset
      - run: wget https://github.com/csia-pme/a-guide-to-mlops/archive/refs/heads/data.zip -O data.zip
      - run: unzip -o data.zip
      - run: mv a-guide-to-mlops-data/ data/
      - run: rm data.zip
      # Run the experiment
      - run: poetry install
      - run: poetry run python src/prepare.py data/data.xml
      - run: poetry run python src/featurization.py data/prepared data/features
      - run: poetry run python src/train.py data/features model.pkl
      - run: poetry run python src/evaluate.py model.pkl data/features

  chapter-2-share-your-ml-experiment-code-with-git:
    save_git: true
    actions:
      # Create a new Git repository
      - run: git init --initial-branch=main
      - run: git status
        log: true
      - replace_from_md:
        file: .gitignore
        occurance_index: 0
      - run: git add .
      - run: git status
        log: true
      - run: git commit -m "My first ML experiment shared on Git"
  
  chapter-3-share-your-ml-experiment-data-with-dvc:
    save_git: true
    actions:
      - run: poetry add "dvc[gs]==2.37.0"
      - run: git diff pyproject.toml
        log: true
      - run: poetry run dvc init
      - run: poetry run dvc remote add -d data gs://mlopsdemo/dvcstore
      - replace_from_md:
        file: .gitignore
        occurance_index: 0
      - run: git diff .gitignore
        log: true
      - run: poetry run dvc add data/data.xml
      - run: poetry run dvc push
      - run: git add .
      - run: git status
        log: true
      - run: git commit -m "My ML experiment data is saved with DVC"

  chapter-4-reproduce-the-experiment-with-dvc:
    save_git: true
    actions:
      - replace_from_md:
        file: .gitignore
        occurance_index: 0
      - run: git diff .gitignore
        log: true
      - run: |-
          poetry run dvc stage add -n prepare \
              -p prepare.seed,prepare.split \
              -d src/prepare.py -d data/data.xml \
              -o data/prepared \
              python src/prepare.py data/data.xml
      - run: |-
          poetry run dvc stage add -n featurize \
              -p featurize.max_features,featurize.ngrams \
              -d src/featurization.py -d data/prepared \
              -o data/features/test.pkl -o data/features/train.pkl \
              python src/featurization.py data/prepared data/features
      - run: |-
          poetry run dvc stage add -n train \
              -p train.seed,train.n_est,train.min_split \
              -d src/train.py -d data/features \
              -o model.pkl \
              python src/train.py data/features model.pkl
      - run: |-
          poetry run dvc stage add -n evaluate \
              -d src/evaluate.py -d model.pkl \
              -o evaluation/plots/metrics \
              -o evaluation/report.html \
              --metrics evaluation/metrics.json \
              --plots evaluation/plots/prc.json \
              --plots evaluation/plots/sklearn/roc.json \
              --plots evaluation/plots/sklearn/confusion_matrix.json \
              --plots evaluation/plots/importance.png \
              python src/evaluate.py model.pkl data/features
      - run: |-
          poetry run dvc plots modify evaluation/plots/prc.json \
              -x recall \
              -y precision
      - run: |-
          poetry run dvc plots modify evaluation/plots/sklearn/roc.json \
              -x fpr \
              -y tpr
      - run: |-
          poetry run dvc plots modify evaluation/plots/sklearn/confusion_matrix.json \
              -x actual \
              -y predicted \
              -t confusion
      - run: poetry run dvc dag
      - run: poetry run dvc repro
      - run: git add .
      - run: git status
        log: true
      - run: poetry run dvc push
      - run: git commit -m "My ML experiment commands are saved with DVC"

  chapter-5-track-model-evolutions-with-dvc:
    save_git: true
    actions:
      - replace_from_md:
        file: params.yaml
        occurance_index: 0
      - run: git diff params.yaml
        log: true
      - run: poetry run dvc repro
      - run: poetry run dvc params diff
        log: true
      - run: poetry run dvc metrics diff
        log: true
      - run: poetry run dvc plots diff
      - replace_from_md:
        file: .gitignore
        occurance_index: 0
      - run: git diff .gitignore
        log: true
      - run: git status
        log: true

  chapter-6-orchestrate-the-workflow-with-a-cicd-pipeline:
    save_git: true
    actions:
      - replace_from_md:
        file: .github/workflows/mlops.yml
        occurance_index: 0
      - replace_from_md:
        file: .gitlab-ci.yml
        occurance_index: 0
      - run: git add .github/workflows/mlops.yml
      - run: git add .gitlab-ci.yml
      - run: git commit -m "A pipeline will run my experiment on each push"

  chapter-7-track-model-evolutions-in-the-cicd-pipeline-with-cml:
    save_git: true
    actions:
      - replace_from_md:
        file: .github/workflows/mlops.yml
        occurance_index: 0
      - run: git diff .github/workflows/mlops.yml
        log: true
      - replace_from_md:
        file: .gitlab-ci.yml
        occurance_index: 0
      - run: git diff .gitlab-ci.yml
        log: true
      - run: git add .github/workflows/mlops.yml
      - run: git add .gitlab-ci.yml
      - run: git commit -m "Enable CML reports on pull requests"
      - run: git add .
      - run: git status
        log: true
      - run: poetry run dvc push
      - run: git commit -m "I made some changes to the model"

  chapter-8-serve-the-model-with-mlem:
    save_git: true
    actions:
      - run: poetry add "mlem[fastapi]==0.4.3"
      - run: git diff pyproject.toml
        log: true
      - run: poetry run mlem init
      - run: poetry run mlem config set core.storage.type dvc
      - run: echo "/**/?*.mlem" >> .dvcignore
      - replace_from_md:
        file: src/featurization.py
        occurance_index: 0
      - run: git diff src/featurization.py
        log: true
      - replace_from_md:
        file: src/train.py
        occurance_index: 0
      - run: git diff src/train.py
        log: true
      - replace_from_md:
        file: src/evaluate.py
        occurance_index: 0
      - run: git diff src/evaluate.py
        log: true
      - run: |-
          poetry run dvc stage add --force \
              -n featurize \
              -p featurize.max_features,featurize.ngrams \
              -d src/featurization.py -d data/prepared \
              -o data/features/test.pkl -o data/features/train.pkl -o data/features/vectorizer -o data/features/tfidf \
              python src/featurization.py data/prepared data/features
      - run: |-
          poetry run dvc stage add --force \
              -n train \
              -p train.seed,train.n_est,train.min_split \
              -d src/train.py -d data/features \
              -o models/rf \
              python src/train.py data/features models/rf
      - run: |-
          poetry run dvc stage add --force \
              -n evaluate \
              -d src/evaluate.py -d models/rf \
              -o evaluation/plots/metrics \
              -o evaluation/report.html \
              --metrics evaluation/metrics.json \
              --plots evaluation/plots/prc.json \
              --plots evaluation/plots/sklearn/roc.json \
              --plots evaluation/plots/sklearn/confusion_matrix.json \
              --plots evaluation/plots/importance.png \
              python src/evaluate.py models/rf data/features
      - run: |-
          poetry run dvc plots modify evaluation/plots/prc.json \
              -x recall \
              -y precision
      - run: |-
          poetry run dvc plots modify evaluation/plots/sklearn/roc.json \
              -x fpr \
              -y tpr
      - run: |-
          poetry run dvc plots modify evaluation/plots/sklearn/confusion_matrix.json \
              -x actual \
              -y predicted \
              -t confusion
      - run: git diff dvc.yaml
        log: true
      - run: poetry run dvc repro
      - run: git add .
      - run: git status
        log: true
      - run: poetry run dvc push
      - run: git commit -m "MLEM can save, load and serve the model"